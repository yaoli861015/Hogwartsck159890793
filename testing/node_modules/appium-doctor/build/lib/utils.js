"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ok = ok;
exports.nok = nok;
exports.okOptional = okOptional;
exports.nokOptional = nokOptional;
exports.configureBinaryLog = configureBinaryLog;
exports.resolveExecutablePath = resolveExecutablePath;
exports.getNpmPackageInfo = getNpmPackageInfo;
exports.authorizeIos = exports.inquirer = exports.pkgRoot = void 0;

require("source-map-support/register");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _path = _interopRequireDefault(require("path"));

var _inquirer2 = _interopRequireDefault(require("inquirer"));

var _logger = _interopRequireDefault(require("../lib/logger"));

var _authorizeIos = _interopRequireDefault(require("authorize-ios"));

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var _lodash = require("lodash");

const authorizeIos = _authorizeIos.default;
exports.authorizeIos = authorizeIos;
const pkgRoot = process.env.NO_PRECOMPILE ? _path.default.resolve(__dirname, '..') : _path.default.resolve(__dirname, '..', '..');
exports.pkgRoot = pkgRoot;

function ok(message) {
  return {
    ok: true,
    optional: false,
    message
  };
}

function nok(message) {
  return {
    ok: false,
    optional: false,
    message
  };
}

function okOptional(message) {
  return {
    ok: true,
    optional: true,
    message
  };
}

function nokOptional(message) {
  return {
    ok: false,
    optional: true,
    message
  };
}

const inquirer = {
  prompt: _bluebird.default.promisify(function (question, cb) {
    _inquirer2.default.prompt(question, function (resp) {
      cb(null, resp);
    });
  })
};
exports.inquirer = inquirer;

function configureBinaryLog(opts) {
  let actualLog = _logger.default.unwrap().log;

  _logger.default.unwrap().log = function (level, prefix, msg) {
    let l = this.levels[level];
    if (l < this.levels[this.level]) return;
    actualLog(level, prefix, msg);

    if ((0, _lodash.isFunction)(opts.onLogMessage)) {
      opts.onLogMessage(level, prefix, msg);
    }
  };

  _logger.default.level = opts.debug ? 'debug' : 'info';
}

async function resolveExecutablePath(cmd) {
  let executablePath;

  try {
    executablePath = await _appiumSupport.fs.which(cmd);

    if (executablePath && (await _appiumSupport.fs.exists(executablePath))) {
      return executablePath;
    }
  } catch (err) {
    if (/not found/gi.test(err.message)) {
      _logger.default.debug(err);
    } else {
      _logger.default.warn(err);
    }
  }

  _logger.default.debug(`No executable path of '${cmd}'.`);

  if (executablePath) {
    _logger.default.debug(`Does '${executablePath}' exist?`);
  }

  return null;
}

async function getNpmPackageInfo(packageName) {
  const npmPath = await resolveExecutablePath(`npm${_appiumSupport.system.isWindows() ? `.cmd` : ''}`);

  if (!npmPath) {
    return nokOptional(`'npm' binary not found in PATH: ${process.env.PATH}`);
  }

  let pJson = {};

  try {
    const {
      stdout
    } = await (0, _teen_process.exec)(npmPath, ['list', '-g', '-l', '-j', packageName]);
    pJson = JSON.parse(stdout);
  } catch (err) {
    _logger.default.debug(err);

    return null;
  }

  if (pJson.dependencies && pJson.dependencies[packageName]) {
    return {
      version: pJson.dependencies[packageName].version,
      path: pJson.path
    };
  }

  return null;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91dGlscy5qcyJdLCJuYW1lcyI6WyJhdXRob3JpemVJb3MiLCJhdXRob3JpemUiLCJwa2dSb290IiwicHJvY2VzcyIsImVudiIsIk5PX1BSRUNPTVBJTEUiLCJwYXRoIiwicmVzb2x2ZSIsIl9fZGlybmFtZSIsIm9rIiwibWVzc2FnZSIsIm9wdGlvbmFsIiwibm9rIiwib2tPcHRpb25hbCIsIm5va09wdGlvbmFsIiwiaW5xdWlyZXIiLCJwcm9tcHQiLCJCIiwicHJvbWlzaWZ5IiwicXVlc3Rpb24iLCJjYiIsIl9pbnF1aXJlciIsInJlc3AiLCJjb25maWd1cmVCaW5hcnlMb2ciLCJvcHRzIiwiYWN0dWFsTG9nIiwibG9nIiwidW53cmFwIiwibGV2ZWwiLCJwcmVmaXgiLCJtc2ciLCJsIiwibGV2ZWxzIiwib25Mb2dNZXNzYWdlIiwiZGVidWciLCJyZXNvbHZlRXhlY3V0YWJsZVBhdGgiLCJjbWQiLCJleGVjdXRhYmxlUGF0aCIsImZzIiwid2hpY2giLCJleGlzdHMiLCJlcnIiLCJ0ZXN0Iiwid2FybiIsImdldE5wbVBhY2thZ2VJbmZvIiwicGFja2FnZU5hbWUiLCJucG1QYXRoIiwic3lzdGVtIiwiaXNXaW5kb3dzIiwiUEFUSCIsInBKc29uIiwic3Rkb3V0IiwiSlNPTiIsInBhcnNlIiwiZGVwZW5kZW5jaWVzIiwidmVyc2lvbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsWUFBWSxHQUFHQyxxQkFBckI7O0FBRUEsTUFBTUMsT0FBTyxHQUFHQyxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsYUFBWixHQUNkQyxjQUFLQyxPQUFMLENBQWFDLFNBQWIsRUFBd0IsSUFBeEIsQ0FEYyxHQUNrQkYsY0FBS0MsT0FBTCxDQUFhQyxTQUFiLEVBQXdCLElBQXhCLEVBQThCLElBQTlCLENBRGxDOzs7QUFHQSxTQUFTQyxFQUFULENBQWFDLE9BQWIs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RUFBK0M7QUFDN0MsUUFBTUMsT0FBTyxHQUFHLE1BQU1YLHFCQUFxQixDQUFFLE1BQUtZLHNCQUFPQyxTQUFQLEtBQXNCLE1BQXRCLEdBQThCLEVBQUcsRUFBeEMsQ0FBM0M7O0FBQ0EsTUFBSSxDQUFDRixPQUFMLEVBQWM7QUFDWixXQUFPaEMsV0FBVyxDQUFFLG1DQUFrQ1gsT0FBTyxDQUFDQyxHQUFSLENBQVk2QyxJQUFLLEVBQXJELENBQWxCO0FBQ0Q7O0FBRUQsTUFBSUMsS0FBSyxHQUFHLEVBQVo7O0FBQ0EsTUFBSTtBQUNGLFVBQU07QUFBQ0MsTUFBQUE7QUFBRCxRQUFXLE1BQU0sd0JBQUtMLE9BQUwsRUFBYyxDQUFDLE1BQUQsRUFBUyxJQUFULEVBQWUsSUFBZixFQUFxQixJQUFyQixFQUEyQkQsV0FBM0IsQ0FBZCxDQUF2QjtBQUNBSyxJQUFBQSxLQUFLLEdBQUdFLElBQUksQ0FBQ0MsS0FBTCxDQUFXRixNQUFYLENBQVI7QUFDRCxHQUhELENBR0UsT0FBT1YsR0FBUCxFQUFZO0FBQ1pmLG9CQUFJUSxLQUFKLENBQVVPLEdBQVY7O0FBQ0EsV0FBTyxJQUFQO0FBQ0Q7O0FBRUQsTUFBSVMsS0FBSyxDQUFDSSxZQUFOLElBQXNCSixLQUFLLENBQUNJLFlBQU4sQ0FBbUJULFdBQW5CLENBQTFCLEVBQTJEO0FBQ3pELFdBQU87QUFBQ1UsTUFBQUEsT0FBTyxFQUFFTCxLQUFLLENBQUNJLFlBQU4sQ0FBbUJULFdBQW5CLEVBQWdDVSxPQUExQztBQUFtRGpELE1BQUFBLElBQUksRUFBRTRDLEtBQUssQ0FBQzVDO0FBQS9ELEtBQVA7QUFDRDs7QUFFRCxTQUFPLElBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IF9pbnF1aXJlciBmcm9tICdpbnF1aXJlcic7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xpYi9sb2dnZXInO1xuaW1wb3J0IGF1dGhvcml6ZSBmcm9tICdhdXRob3JpemUtaW9zJztcbmltcG9ydCB7IGZzLCBzeXN0ZW0gfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCB7IGlzRnVuY3Rpb24gfSBmcm9tICdsb2Rhc2gnO1xuXG4vLyByZW5hbWUgdG8gbWFrZSBtb3JlIHNlbnNlXG5jb25zdCBhdXRob3JpemVJb3MgPSBhdXRob3JpemU7XG5cbmNvbnN0IHBrZ1Jvb3QgPSBwcm9jZXNzLmVudi5OT19QUkVDT01QSUxFID9cbiAgcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJykgOiBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnLi4nKTtcblxuZnVuY3Rpb24gb2sgKG1lc3NhZ2UpIHtcbiAgcmV0dXJuIHtvazogdHJ1ZSwgb3B0aW9uYWw6IGZhbHNlLCBtZXNzYWdlfTtcbn1cbmZ1bmN0aW9uIG5vayAobWVzc2FnZSkge1xuICByZXR1cm4ge29rOiBmYWxzZSwgb3B0aW9uYWw6IGZhbHNlLCBtZXNzYWdlfTtcbn1cbmZ1bmN0aW9uIG9rT3B0aW9uYWwgKG1lc3NhZ2UpIHtcbiAgcmV0dXJuIHtvazogdHJ1ZSwgb3B0aW9uYWw6IHRydWUsIG1lc3NhZ2V9O1xufVxuZnVuY3Rpb24gbm9rT3B0aW9uYWwgKG1lc3NhZ2UpIHtcbiAgcmV0dXJuIHtvazogZmFsc2UsIG9wdGlvbmFsOiB0cnVlLCBtZXNzYWdlfTtcbn1cblxuY29uc3QgaW5xdWlyZXIgPSB7XG4gIHByb21wdDogQi5wcm9taXNpZnkoZnVuY3Rpb24gKHF1ZXN0aW9uLCBjYikgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHByb21pc2UvcHJlZmVyLWF3YWl0LXRvLWNhbGxiYWNrc1xuICAgIF9pbnF1aXJlci5wcm9tcHQocXVlc3Rpb24sIGZ1bmN0aW9uIChyZXNwKSB7IGNiKG51bGwsIHJlc3ApOyB9KTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBwcm9taXNlL3ByZWZlci1hd2FpdC10by1jYWxsYmFja3NcbiAgfSlcbn07XG5cbmZ1bmN0aW9uIGNvbmZpZ3VyZUJpbmFyeUxvZyAob3B0cykge1xuICBsZXQgYWN0dWFsTG9nID0gbG9nLnVud3JhcCgpLmxvZztcbiAgbG9nLnVud3JhcCgpLmxvZyA9IGZ1bmN0aW9uIChsZXZlbCwgcHJlZml4LCBtc2cpIHtcbiAgICBsZXQgbCA9IHRoaXMubGV2ZWxzW2xldmVsXTtcbiAgICBpZiAobCA8IHRoaXMubGV2ZWxzW3RoaXMubGV2ZWxdKSByZXR1cm47IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcbiAgICBhY3R1YWxMb2cobGV2ZWwsIHByZWZpeCwgbXNnKTtcblxuICAgIGlmIChpc0Z1bmN0aW9uKG9wdHMub25Mb2dNZXNzYWdlKSkge1xuICAgICAgb3B0cy5vbkxvZ01lc3NhZ2UobGV2ZWwsIHByZWZpeCwgbXNnKTtcbiAgICB9XG4gIH07XG4gIGxvZy5sZXZlbCA9IG9wdHMuZGVidWcgPyAnZGVidWcnIDogJ2luZm8nO1xufVxuXG4vKipcbiAqIFJldHVybiBhbiBleGVjdXRhYmxlIHBhdGggb2YgY21kXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGNtZCBTdGFuZGFyZCBvdXRwdXQgYnkgY29tbWFuZFxuICogQHJldHVybiB7P3N0cmluZ30gVGhlIGZ1bGwgcGF0aCBvZiBjbWQuIGBudWxsYCBpZiB0aGUgY21kIGlzIG5vdCBmb3VuZC5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gcmVzb2x2ZUV4ZWN1dGFibGVQYXRoIChjbWQpIHtcbiAgbGV0IGV4ZWN1dGFibGVQYXRoO1xuICB0cnkge1xuICAgIGV4ZWN1dGFibGVQYXRoID0gYXdhaXQgZnMud2hpY2goY21kKTtcbiAgICBpZiAoZXhlY3V0YWJsZVBhdGggJiYgYXdhaXQgZnMuZXhpc3RzKGV4ZWN1dGFibGVQYXRoKSkge1xuICAgICAgcmV0dXJuIGV4ZWN1dGFibGVQYXRoO1xuICAgIH1cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKCgvbm90IGZvdW5kL2dpKS50ZXN0KGVyci5tZXNzYWdlKSkge1xuICAgICAgbG9nLmRlYnVnKGVycik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy53YXJuKGVycik7XG4gICAgfVxuICB9XG4gIGxvZy5kZWJ1ZyhgTm8gZXhlY3V0YWJsZSBwYXRoIG9mICcke2NtZH0nLmApO1xuICBpZiAoZXhlY3V0YWJsZVBhdGgpIHtcbiAgICBsb2cuZGVidWcoYERvZXMgJyR7ZXhlY3V0YWJsZVBhdGh9JyBleGlzdD9gKTtcbiAgfVxuICByZXR1cm4gbnVsbDtcbn1cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBOcG1QYWNrYWdlSW5mb1xuICogQHByb3BlcnR5IHtzdHJpbmd9IHZlcnNpb24gLSB2ZXJzaW9uXG4gKiBAcHJvcGVydHkge3N0cmluZ30gcGF0aCAtIEEgcGF0aCB0byBucG0gcm9vdFxuICovXG4vKipcbiAqIFJldHVybnMgdGhlIHBhdGggYW5kIHZlcnNpb24gb2YgZ2l2ZW4gcGFja2FnZSBuYW1lXG4gKiBAcGFyYW0ge3N0cmluZ30gcGFja2FnZU5hbWUgQSBwYWNrYWdlIG5hbWUgdG8gZ2V0IHBhdGggYW5kIHZlcnNpb24gZGF0YVxuICogQHJldHVybiB7P05wbVBhY2thZ2VJbmZvfVxuICovXG5hc3luYyBmdW5jdGlvbiBnZXROcG1QYWNrYWdlSW5mbyAocGFja2FnZU5hbWUpIHtcbiAgY29uc3QgbnBtUGF0aCA9IGF3YWl0IHJlc29sdmVFeGVjdXRhYmxlUGF0aChgbnBtJHtzeXN0ZW0uaXNXaW5kb3dzKCkgPyBgLmNtZGAgOiAnJ31gKTtcbiAgaWYgKCFucG1QYXRoKSB7XG4gICAgcmV0dXJuIG5va09wdGlvbmFsKGAnbnBtJyBiaW5hcnkgbm90IGZvdW5kIGluIFBBVEg6ICR7cHJvY2Vzcy5lbnYuUEFUSH1gKTtcbiAgfVxuXG4gIGxldCBwSnNvbiA9IHt9O1xuICB0cnkge1xuICAgIGNvbnN0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYyhucG1QYXRoLCBbJ2xpc3QnLCAnLWcnLCAnLWwnLCAnLWonLCBwYWNrYWdlTmFtZV0pO1xuICAgIHBKc29uID0gSlNPTi5wYXJzZShzdGRvdXQpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cuZGVidWcoZXJyKTtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGlmIChwSnNvbi5kZXBlbmRlbmNpZXMgJiYgcEpzb24uZGVwZW5kZW5jaWVzW3BhY2thZ2VOYW1lXSkge1xuICAgIHJldHVybiB7dmVyc2lvbjogcEpzb24uZGVwZW5kZW5jaWVzW3BhY2thZ2VOYW1lXS52ZXJzaW9uLCBwYXRoOiBwSnNvbi5wYXRofTtcbiAgfVxuXG4gIHJldHVybiBudWxsO1xufVxuXG5leHBvcnQgeyBwa2dSb290LCBvaywgbm9rLCBva09wdGlvbmFsLCBub2tPcHRpb25hbCwgaW5xdWlyZXIsIGNvbmZpZ3VyZUJpbmFyeUxvZyxcbiAgYXV0aG9yaXplSW9zLCByZXNvbHZlRXhlY3V0YWJsZVBhdGgsIGdldE5wbVBhY2thZ2VJbmZvfTtcbiJdLCJmaWxlIjoibGliL3V0aWxzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
